generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Cart {
  id           Int        @id @default(autoincrement())
  userId       Int        @unique
  mobileNumber String?
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items        CartItem[]

  @@map("Cart")
}

model User {
  id               Int           @id @default(autoincrement())
  name             String
  email            String        @unique
  password         String
  role             String
  createdAt        DateTime      @default(now())
  phone            String?
  loanBalance      Float         @default(0) // actual amount of the user
  refundedTotal    Float         @default(0)
  hasLoan          Boolean       @default(false)
  adminLoanBalance Float?        @db.Float
  isLoggedIn       Boolean       @default(false)  // ðŸ‘ˆ NEW FIELD ADDED
  cart             Cart?
  orders           Order[]
  TopUp            TopUp[]
  transactions     Transaction[]

  @@map("User")
}

model CartItem {
  id           Int     @id @default(autoincrement())
  cartId       Int
  quantity     Int     @default(1)
  price        Float
  productId    Int
  mobileNumber String?
  cart         Cart    @relation(fields: [cartId], references: [id])
  product      Product @relation(fields: [productId], references: [id])

  @@index([cartId], map: "CartItem_cartId_fkey")
  @@index([productId], map: "CartItem_productId_fkey")
  @@map("CartItem")
}

model Product {
  id          Int         @id @default(autoincrement())
  name        String
  description String?
  price       Float
  stock       Int         @default(0)
  showOnShop  Boolean     @default(false)
  createdAt   DateTime    @default(now())
  CartItem    CartItem[]
  OrderItem   OrderItem[]

  @@map("Product")
}

model Order {
  id           Int         @id @default(autoincrement())
  userId       Int
  createdAt    DateTime    @default(now())
  status       String      @default("Pending")
  mobileNumber String?
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items        OrderItem[]

  @@index([userId], map: "Order_userId_fkey")
  @@index([createdAt])
  @@index([status])
  @@index([mobileNumber])
  @@index([userId, createdAt])
  @@map("Order")
}

model OrderItem {
  id           Int     @id @default(autoincrement())
  orderId      Int
  productId    Int
  quantity     Int
  mobileNumber String?
  status       String  @default("Pending")
  order        Order   @relation(fields: [orderId], references: [id])
  product      Product @relation(fields: [productId], references: [id])

  @@index([orderId], map: "OrderItem_orderId_fkey")
  @@index([productId], map: "OrderItem_productId_fkey")
  @@index([status])
  @@index([mobileNumber])
  @@index([orderId, status])
  @@map("OrderItem")
}

model TopUp {
  id          Int      @id @default(autoincrement())
  userId      Int
  referenceId String   @unique
  amount      Float
  status      String   @default("Pending")
  submittedBy String
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "TopUp_userId_fkey")
  @@map("TopUp")
}

model Upload {
  id         Int        @id @default(autoincrement())
  filename   String     @db.VarChar(255)
  filePath   String?    @db.VarChar(255)
  uploadedAt DateTime?  @db.DateTime(0)
  userId     String?    @db.VarChar(255)
  purchases  Purchase[]

  @@map("Upload")
}

model Purchase {
  id              Int    @id @default(autoincrement())
  phone           String @db.VarChar(20)
  price           String @db.VarChar(100)
  itemDescription String @db.Text
  uploadedFileId  Int
  uploadedFile    Upload @relation(fields: [uploadedFileId], references: [id], onDelete: Cascade, onUpdate: Restrict)

  @@index([uploadedFileId], map: "uploaded_file_id")
  @@map("Purchase")
}

model Transaction {
  id             Int       @id @default(autoincrement())
  userId         Int
  amount         Float
  balance        Float
  previousBalance Float    @default(0) 
  type           String    @db.VarChar(191)
  description    String    @db.Text
  reference      String?   @db.VarChar(255)
  createdAt      DateTime? @default(now()) @db.DateTime(3)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Restrict, map: "fk_user_transaction")

  @@index([userId], map: "fk_user_transaction")
  @@index([userId, createdAt])
  @@index([type])
  @@index([createdAt])
  @@index([reference])
  @@map("Transaction")
}

model Announcement {
  id        String   @id @default(cuid())
  title     String
  message   String
  isActive  Boolean  @default(true)
  priority  Int      @default(1) // Higher numbers = higher priority
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String   // Admin user ID who created it
  
  @@map("Announcements")
}

model SmsMessage {
  id          Int      @id @default(autoincrement())
  phoneNumber String   @db.VarChar(20)
  message     String   @db.Text
  reference   String?  @db.VarChar(255)
  amount      Float?
  isProcessed Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  @@map("SmsMessage")
}

model Shop {
  id                 Int      @id @default(autoincrement())
  amount             Float
  reference          String   @db.VarChar(255)
  phoneNumber        String   @db.VarChar(20)
  message            String?  @db.Text
  deduction          Float?
  fullName           String?  @db.VarChar(255)
  productName        String?  @db.VarChar(255)
  productDescription String?  @db.VarChar(255)
  productPrice       Float?
  status             String   @default("Pending")
  orderTime          DateTime @default(now())
  createdAt          DateTime @default(now())
  
  @@index([reference])
  @@index([phoneNumber])
  @@index([orderTime])
  @@index([status])
  @@map("Shop")
}

model Complaint {
  id             Int      @id @default(autoincrement())
  fullName       String   @db.VarChar(255)
  mobileNumber   String   @db.VarChar(20)
  productName    String   @db.VarChar(255)
  productCost    Float
  transactionId  String   @db.VarChar(255)
  complaint      String   @db.Text
  orderTime      DateTime
  createdAt      DateTime @default(now())
  status         String   @default("Pending")
  
  @@index([mobileNumber])
  @@index([transactionId])
  @@index([status])
  @@map("Complaint")
}

model AgentStorefront {
  id              Int                      @id @default(autoincrement())
  agentId         Int                      @unique
  storeName       String                   @db.VarChar(255)
  momoNumber      String                   @db.VarChar(20)
  momoName        String                   @db.VarChar(255)
  storeSlug       String                   @unique @db.VarChar(100)
  isActive        Boolean                  @default(true)
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  products        AgentStorefrontProduct[]
  orders          AgentStoreOrder[]
  
  @@index([agentId])
  @@index([storeSlug])
  @@map("AgentStorefront")
}

model AgentStorefrontProduct {
  id              Int             @id @default(autoincrement())
  storefrontId    Int
  productId       Int
  customPrice     Float
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  storefront      AgentStorefront @relation(fields: [storefrontId], references: [id], onDelete: Cascade)
  
  @@unique([storefrontId, productId])
  @@index([storefrontId])
  @@index([productId])
  @@map("AgentStorefrontProduct")
}

model AgentStoreOrder {
  id                 Int             @id @default(autoincrement())
  storefrontId       Int
  customerName       String          @db.VarChar(255)
  customerPhone      String          @db.VarChar(20)
  productId          Int
  productName        String          @db.VarChar(255)
  productDescription String?         @db.VarChar(255)
  customerPrice      Float
  agentPrice         Float
  transactionId      String          @db.VarChar(255)
  status             String          @default("Pending")
  isAddedToCart      Boolean         @default(false)
  isPushedToAdmin    Boolean         @default(false)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  storefront         AgentStorefront @relation(fields: [storefrontId], references: [id], onDelete: Cascade)
  
  @@index([storefrontId])
  @@index([status])
  @@index([transactionId])
  @@index([isPushedToAdmin])
  @@index([isAddedToCart])
  @@map("AgentStoreOrder")
}